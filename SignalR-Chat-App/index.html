<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <style type="text/css">
        .container {
            display: flex;
            justify-content: center;
            background-color: #99CCFF;
            border: thick solid #808080;
        }
        ul {
            padding: 0;
            list-style: none;
            margin: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <ul id="connected"></ul>
        <ul id="group"></ul>
        <ul id="chat"></ul>
    </div>
    <button id="room">Join Room</button>
    <br />
    <br />

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        // Declare a proxy to reference the hub.
        var connection = $.hubConnection();
        var chatHub = connection.createHubProxy('chatHub');
        var currentGroup = null;


        // Shows all connected users
        chatHub.on('connectedUsers', function (usersJson) {
            $('#connected').html('');
            var users = JSON.parse(usersJson);
            $('#connected').append(users.reduce((result, name) => result + "<li>" + name + "</li>", "<h5><strong>USERS</strong></h5>"));
        });

        // Triggers when a user joins a room
        chatHub.on('roomChanged', function () {
            chatHub.invoke('RoomUsers', currentGroup);
        });

        // Displays the users in the group
        chatHub.on('inGroup', function (usersJson) {
            $('#group').html('');
            var users = JSON.parse(usersJson);
            $('#group').append(users.reduce((result, name) => result + "<li>" + name + "</li>", "<h5><strong>ROOM: " + currentGroup + "</strong></h5>"));
        });

        chatHub.on('groupMessage', function (msg) {
            $('#chat').append("<li />", msg);
        });


        var clickHandler = function () {
            if (currentGroup === null) {
                currentGroup = prompt("Room Name: ");
                chatHub.invoke('JoinRoom', currentGroup);
                $('#room').text("Leave Room");
                $('body').append('<input type="text" id="message" /><input type="button" value="Send" onclick="sendMessage()" />');
            } else {
                $('#group').html('');
                chatHub.invoke('LeaveRoom', currentGroup);
                currentGroup = null;
                $('#room').text("Join Room");
            }
        };

        function sendMessage() {
            chatHub.invoke('groupMessage', currentGroup, $('#message').val());
            $('#message').val('');
        };

        // Get the users name and start the hub connection
        Promise.resolve(prompt("Enter display name: "))
        .then(function (name) {
            // Pass user name as querystring to server
            connection.qs = { 'username': name };
            // Start the connection.
            connection.start().done(function () {
                $('#room').click(clickHandler);
            });
        }, function (error) { alert(error) });
    </script>
</body>
</html>